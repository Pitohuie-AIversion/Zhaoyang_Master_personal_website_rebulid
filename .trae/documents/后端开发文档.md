# 牟昭阳个人网站后端开发文档

## 1. 项目概述

### 1.1 技术栈选择
- **后端服务**: Supabase (PostgreSQL + RESTful API + 实时功能)
- **数据库**: PostgreSQL (Supabase 托管)
- **认证系统**: Supabase Auth
- **文件存储**: Supabase Storage
- **前端集成**: @supabase/supabase-js v2.39.0

### 1.2 架构升级
从纯前端静态网站升级为动态网站：
- **当前**: 本地 JSON 数据 → **目标**: Supabase 数据库
- **当前**: 静态内容 → **目标**: 动态内容管理
- **新增**: 用户认证、内容管理后台、访问统计

## 2. 数据库设计

### 2.1 核心数据表

#### 2.1.1 研究成果表 (research_items)
```sql
CREATE TABLE research_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title_zh TEXT NOT NULL,
  title_en TEXT NOT NULL,
  description_zh TEXT NOT NULL,
  description_en TEXT NOT NULL,
  category VARCHAR(50) NOT NULL, -- 'cfd', 'robotics', 'ml'
  status VARCHAR(20) DEFAULT 'published', -- 'draft', 'published', 'archived'
  image_url TEXT,
  tags TEXT[], -- 数组类型存储标签
  metrics JSONB, -- 存储统计数据 {citations: 10, views: 100}
  external_links JSONB, -- {paper_url: '', github_url: '', demo_url: ''}
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  sort_order INTEGER DEFAULT 0
);
```

#### 2.1.2 项目表 (projects)
```sql
CREATE TABLE projects (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title_zh TEXT NOT NULL,
  title_en TEXT NOT NULL,
  description_zh TEXT NOT NULL,
  description_en TEXT NOT NULL,
  category VARCHAR(50) NOT NULL, -- 'research', 'development', 'hardware'
  status VARCHAR(20) DEFAULT 'completed', -- 'planning', 'in_progress', 'completed', 'archived'
  tech_stack TEXT[], -- 技术栈数组
  highlights_zh TEXT[],
  highlights_en TEXT[],
  image_url TEXT,
  gallery_urls TEXT[], -- 项目图片集
  github_url TEXT,
  demo_url TEXT,
  paper_url TEXT,
  start_date DATE,
  end_date DATE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  sort_order INTEGER DEFAULT 0,
  featured BOOLEAN DEFAULT FALSE -- 是否为特色项目
);
```

#### 2.1.3 学术成果表 (publications)
```sql
CREATE TABLE publications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  type VARCHAR(20) NOT NULL, -- 'paper', 'patent', 'award'
  title_zh TEXT NOT NULL,
  title_en TEXT NOT NULL,
  authors_zh TEXT[],
  authors_en TEXT[],
  journal_zh TEXT,
  journal_en TEXT,
  publication_date DATE,
  doi TEXT,
  patent_number TEXT,
  award_organization_zh TEXT,
  award_organization_en TEXT,
  description_zh TEXT,
  description_en TEXT,
  pdf_url TEXT,
  external_url TEXT,
  citation_count INTEGER DEFAULT 0,
  impact_factor DECIMAL(4,2),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  sort_order INTEGER DEFAULT 0
);
```

#### 2.1.4 技能表 (skills)
```sql
CREATE TABLE skills (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  category VARCHAR(50) NOT NULL, -- 'programming', 'simulation', 'ai_ml', 'hardware', 'tools'
  level INTEGER NOT NULL CHECK (level >= 0 AND level <= 100),
  description_zh TEXT,
  description_en TEXT,
  projects TEXT[], -- 相关项目
  years_experience INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  sort_order INTEGER DEFAULT 0
);
```

#### 2.1.5 联系表单表 (contact_submissions)
```sql
CREATE TABLE contact_submissions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  subject TEXT NOT NULL,
  message TEXT NOT NULL,
  collaboration_type VARCHAR(50), -- 'research', 'development', 'consulting', 'other'
  budget_range VARCHAR(20),
  timeline VARCHAR(20),
  status VARCHAR(20) DEFAULT 'new', -- 'new', 'read', 'replied', 'archived'
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  replied_at TIMESTAMP WITH TIME ZONE
);
```

#### 2.1.6 网站统计表 (site_analytics)
```sql
CREATE TABLE site_analytics (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  page_path TEXT NOT NULL,
  visitor_id TEXT, -- 匿名访客ID
  session_id TEXT,
  referrer TEXT,
  user_agent TEXT,
  ip_address INET,
  country TEXT,
  city TEXT,
  device_type VARCHAR(20), -- 'desktop', 'tablet', 'mobile'
  browser VARCHAR(50),
  language VARCHAR(10),
  visit_duration INTEGER, -- 停留时间(秒)
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.2 数据库索引优化
```sql
-- 研究成果索引
CREATE INDEX idx_research_items_category ON research_items(category);
CREATE INDEX idx_research_items_status ON research_items(status);
CREATE INDEX idx_research_items_created_at ON research_items(created_at DESC);

-- 项目索引
CREATE INDEX idx_projects_category ON projects(category);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_featured ON projects(featured);

-- 学术成果索引
CREATE INDEX idx_publications_type ON publications(type);
CREATE INDEX idx_publications_date ON publications(publication_date DESC);

-- 技能索引
CREATE INDEX idx_skills_category ON skills(category);

-- 联系表单索引
CREATE INDEX idx_contact_status ON contact_submissions(status);
CREATE INDEX idx_contact_created_at ON contact_submissions(created_at DESC);

-- 统计索引
CREATE INDEX idx_analytics_page_path ON site_analytics(page_path);
CREATE INDEX idx_analytics_created_at ON site_analytics(created_at DESC);
```

## 3. API 接口设计

### 3.1 RESTful API 规范

#### 3.1.1 基础配置
```typescript
// supabase 客户端配置
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://your-project.supabase.co'
const supabaseAnonKey = 'your-anon-key'

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

#### 3.1.2 研究成果 API
```typescript
// 获取所有研究成果
GET /rest/v1/research_items?select=*&order=sort_order.asc,created_at.desc

// 按类别筛选
GET /rest/v1/research_items?category=eq.cfd&select=*

// 搜索研究成果
GET /rest/v1/research_items?or=(title_zh.ilike.*keyword*,title_en.ilike.*keyword*)

// 获取单个研究成果详情
GET /rest/v1/research_items?id=eq.{id}&select=*

// 创建研究成果 (需要认证)
POST /rest/v1/research_items
Content-Type: application/json
Authorization: Bearer {jwt_token}

{
  "title_zh": "标题",
  "title_en": "Title",
  "description_zh": "描述",
  "description_en": "Description",
  "category": "cfd",
  "tags": ["CFD", "机器学习"],
  "external_links": {
    "paper_url": "https://...",
    "github_url": "https://..."
  }
}
```

#### 3.1.3 项目 API
```typescript
// 获取所有项目
GET /rest/v1/projects?select=*&order=featured.desc,sort_order.asc

// 获取特色项目
GET /rest/v1/projects?featured=eq.true&select=*

// 按状态筛选
GET /rest/v1/projects?status=eq.completed&select=*

// 项目统计
GET /rest/v1/projects?select=category&group=category
```

#### 3.1.4 学术成果 API
```typescript
// 获取所有学术成果
GET /rest/v1/publications?select=*&order=publication_date.desc

// 按类型筛选
GET /rest/v1/publications?type=eq.paper&select=*

// 获取统计数据
GET /rest/v1/publications?select=type,count&group=type
```

#### 3.1.5 技能 API
```typescript
// 获取所有技能
GET /rest/v1/skills?select=*&order=category.asc,level.desc

// 按类别获取技能
GET /rest/v1/skills?category=eq.programming&select=*

// 技能雷达图数据
GET /rest/v1/skills?select=category,avg(level)&group=category
```

#### 3.1.6 联系表单 API
```typescript
// 提交联系表单
POST /rest/v1/contact_submissions
Content-Type: application/json

{
  "name": "姓名",
  "email": "email@example.com",
  "subject": "主题",
  "message": "消息内容",
  "collaboration_type": "research",
  "budget_range": "10k-50k",
  "timeline": "medium"
}

// 获取表单列表 (需要管理员权限)
GET /rest/v1/contact_submissions?select=*&order=created_at.desc
Authorization: Bearer {admin_jwt_token}
```

### 3.2 实时功能 (Realtime)
```typescript
// 监听新的联系表单提交
supabase
  .channel('contact_submissions')
  .on('postgres_changes', 
    { event: 'INSERT', schema: 'public', table: 'contact_submissions' },
    (payload) => {
      console.log('新的联系表单:', payload.new)
      // 发送通知给管理员
    }
  )
  .subscribe()

// 监听访问统计
supabase
  .channel('site_analytics')
  .on('postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'site_analytics' },
    (payload) => {
      // 实时更新访问统计
    }
  )
  .subscribe()
```

## 4. 前后端对接方案

### 4.1 数据服务层重构

#### 4.1.1 创建 Supabase 服务
```typescript
// src/services/supabaseService.ts
import { supabase } from '../lib/supabase'

export class SupabaseService {
  // 研究成果服务
  async getResearchItems(category?: string) {
    let query = supabase
      .from('research_items')
      .select('*')
      .eq('status', 'published')
      .order('sort_order', { ascending: true })
      .order('created_at', { ascending: false })

    if (category) {
      query = query.eq('category', category)
    }

    const { data, error } = await query
    if (error) throw error
    return data
  }

  // 项目服务
  async getProjects(featured?: boolean) {
    let query = supabase
      .from('projects')
      .select('*')
      .order('featured', { ascending: false })
      .order('sort_order', { ascending: true })

    if (featured !== undefined) {
      query = query.eq('featured', featured)
    }

    const { data, error } = await query
    if (error) throw error
    return data
  }

  // 学术成果服务
  async getPublications(type?: string) {
    let query = supabase
      .from('publications')
      .select('*')
      .order('publication_date', { ascending: false })

    if (type) {
      query = query.eq('type', type)
    }

    const { data, error } = await query
    if (error) throw error
    return data
  }

  // 技能服务
  async getSkills() {
    const { data, error } = await supabase
      .from('skills')
      .select('*')
      .order('category', { ascending: true })
      .order('level', { ascending: false })

    if (error) throw error
    return data
  }

  // 提交联系表单
  async submitContactForm(formData: any) {
    const { data, error } = await supabase
      .from('contact_submissions')
      .insert([formData])
      .select()

    if (error) throw error
    return data
  }

  // 记录访问统计
  async trackPageView(pageData: any) {
    const { data, error } = await supabase
      .from('site_analytics')
      .insert([pageData])

    if (error) console.error('Analytics error:', error)
    return data
  }
}

export const supabaseService = new SupabaseService()
```

#### 4.1.2 更新现有服务
```typescript
// src/services/dataService.ts - 新建统一数据服务
import { supabaseService } from './supabaseService'

// 兼容现有代码的数据转换层
export class DataService {
  async getHomeData() {
    const [research, projects, publications] = await Promise.all([
      supabaseService.getResearchItems(),
      supabaseService.getProjects(true), // 只获取特色项目
      supabaseService.getPublications()
    ])

    return {
      researchHighlights: research.slice(0, 3),
      featuredProjects: projects.slice(0, 3),
      recentPublications: publications.slice(0, 5),
      stats: {
        publications: publications.filter(p => p.type === 'paper').length,
        projects: projects.length,
        patents: publications.filter(p => p.type === 'patent').length,
        awards: publications.filter(p => p.type === 'award').length
      }
    }
  }

  async getResearchData() {
    return await supabaseService.getResearchItems()
  }

  async getProjectsData() {
    return await supabaseService.getProjects()
  }

  async getPublicationsData() {
    return await supabaseService.getPublications()
  }

  async getSkillsData() {
    const skills = await supabaseService.getSkills()
    
    // 转换为现有格式
    const skillCategories = skills.reduce((acc, skill) => {
      if (!acc[skill.category]) {
        acc[skill.category] = []
      }
      acc[skill.category].push(skill)
      return acc
    }, {})

    return skillCategories
  }
}

export const dataService = new DataService()
```

### 4.2 组件更新策略

#### 4.2.1 使用 React Query 进行数据管理
```typescript
// src/hooks/useData.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { dataService } from '../services/dataService'

export const useResearchData = () => {
  return useQuery({
    queryKey: ['research'],
    queryFn: () => dataService.getResearchData(),
    staleTime: 5 * 60 * 1000, // 5分钟缓存
  })
}

export const useProjectsData = () => {
  return useQuery({
    queryKey: ['projects'],
    queryFn: () => dataService.getProjectsData(),
    staleTime: 5 * 60 * 1000,
  })
}

export const useContactForm = () => {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: (formData) => supabaseService.submitContactForm(formData),
    onSuccess: () => {
      // 提交成功后的处理
      queryClient.invalidateQueries(['contact'])
    }
  })
}
```

#### 4.2.2 页面组件更新示例
```typescript
// src/pages/Research.tsx - 更新示例
import { useResearchData } from '../hooks/useData'

export default function Research() {
  const { data: researchItems, isLoading, error } = useResearchData()

  if (isLoading) return <LoadingComponent />
  if (error) return <ErrorComponent error={error} />

  return (
    <div>
      {researchItems?.map(item => (
        <ResearchCard key={item.id} item={item} />
      ))}
    </div>
  )
}
```

### 4.3 环境配置

#### 4.3.1 环境变量
```bash
# .env.local
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

#### 4.3.2 Supabase 客户端配置
```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables')
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
})

// 数据库类型定义
export type Database = {
  public: {
    Tables: {
      research_items: {
        Row: {
          id: string
          title_zh: string
          title_en: string
          description_zh: string
          description_en: string
          category: string
          status: string
          image_url: string | null
          tags: string[] | null
          metrics: any | null
          external_links: any | null
          created_at: string
          updated_at: string
          sort_order: number
        }
        Insert: {
          // 插入时的类型定义
        }
        Update: {
          // 更新时的类型定义
        }
      }
      // 其他表的类型定义...
    }
  }
}
```

## 5. 部署和运维

### 5.1 Supabase 项目设置
1. 创建 Supabase 项目
2. 执行数据库迁移脚本
3. 配置 RLS (Row Level Security) 策略
4. 设置存储桶用于图片上传
5. 配置认证提供商

### 5.2 安全策略
```sql
-- RLS 策略示例
-- 研究成果表：公开读取，管理员写入
ALTER TABLE research_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "研究成果公开读取" ON research_items
  FOR SELECT USING (status = 'published');

CREATE POLICY "管理员可以管理研究成果" ON research_items
  FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- 联系表单：任何人可以插入，管理员可以查看
ALTER TABLE contact_submissions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "任何人可以提交联系表单" ON contact_submissions
  FOR INSERT WITH CHECK (true);

CREATE POLICY "管理员可以查看联系表单" ON contact_submissions
  FOR SELECT USING (auth.jwt() ->> 'role' = 'admin');
```

### 5.3 数据迁移计划
1. **阶段一**: 创建数据库表结构
2. **阶段二**: 迁移现有 JSON 数据到数据库
3. **阶段三**: 更新前端代码使用新的数据服务
4. **阶段四**: 测试和优化
5. **阶段五**: 上线部署

## 6. 开发时间线

### 第一周：基础设施搭建
- [ ] 创建 Supabase 项目
- [ ] 设计并创建数据库表
- [ ] 配置 RLS 安全策略
- [ ] 数据迁移脚本开发

### 第二周：API 开发和测试
- [ ] 开发 Supabase 服务层
- [ ] 创建数据转换层
- [ ] API 接口测试
- [ ] 错误处理和日志

### 第三周：前端集成
- [ ] 更新前端组件使用新 API
- [ ] 添加 React Query 数据管理
- [ ] 实时功能集成
- [ ] 性能优化

### 第四周：测试和部署
- [ ] 端到端测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 生产环境部署

这个开发文档为你的个人网站后端开发提供了完整的技术方案。你觉得这个方案如何？需要我详细解释某个部分或者开始实际的开发工作吗？